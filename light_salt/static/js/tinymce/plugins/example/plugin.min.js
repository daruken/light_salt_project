function toDataUrl(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {
        var reader = new FileReader();
        reader.onloadend = function() {
            callback(reader.result);
        }
        reader.readAsDataURL(xhr.response);
    };
    xhr.open('GET', url);
    xhr.responseType = 'blob';
    xhr.send();
}

tinymce.PluginManager.add('example', function(editor, url) {
  editor.addCommand('Example', function() {
        
		var currentImage; // assigned when the Edit button is clicked
      
      // Image Editor configuration
      var csdkImageEditor = new Aviary.Feather({
        apiKey: configObj.apiKey,
        onSave: function(imageID, newURL) {
          currentImage.src = newURL;  //모든 작업이 끝난 후 저장
          /* 이부분이 문제네 ㅠㅠ */
          
          toDataUrl(newURL, function(myBase64) {
            var resultString = '<img src="' + myBase64 + '"/>';
            //console.log(resultString); // myBase64 is the base64 string
						editor.selection.setContent('');
            editor.selection.setContent(resultString);
          });          
          /* 이부분이 문제네 ㅠㅠ */
          csdkImageEditor.close();
        },
        onError: function(errorObj) {
          console.log(errorObj.code);
          console.log(errorObj.message);
          console.log(errorObj.args);
        }
      });
      
      currentImage = $('#editable-image')[0];
      
      var replaceText = editor.selection.getContent();
      
      /* 깔끔한 방법이 있을까..? */
      replaceText = replaceText.replace('<img', '');
      replaceText = replaceText.replace('src=', '');
      replaceText = replaceText.replace('"', '');
      replaceText = replaceText.replace('"', '');
      replaceText = replaceText.replace('/>', '');
      
      currentImage.src = replaceText;
		csdkImageEditor.launch({
			image: currentImage.id,
			url: currentImage.src
		});

    });
	
	// Add a button that opens a window
  editor.addButton('example', {
		id : "example",
    text: false,
    icon: 'image',
    onclick: function() {
      var currentImage; // assigned when the Edit button is clicked
      
      // Image Editor configuration
      var csdkImageEditor = new Aviary.Feather({
        apiKey: configObj.apiKey,
        onSave: function(imageID, newURL) {
          currentImage.src = newURL;  //모든 작업이 끝난 후 저장
          /* 이부분이 문제네 ㅠㅠ */
          
          toDataUrl(newURL, function(myBase64) {
            var resultString = '<img src="' + myBase64 + '"/>';
            //console.log(resultString); // myBase64 is the base64 string
						editor.selection.setContent('');
            editor.selection.setContent(resultString);
          });          
          /* 이부분이 문제네 ㅠㅠ */
          csdkImageEditor.close();
        },
        onError: function(errorObj) {
          console.log(errorObj.code);
          console.log(errorObj.message);
          console.log(errorObj.args);
        }
      });
      
      currentImage = $('#editable-image')[0];
      
      var replaceText = editor.selection.getContent();
      
      /* 깔끔한 방법이 있을까..? */
      replaceText = replaceText.replace('<img', '');
      replaceText = replaceText.replace('src=', '');
      replaceText = replaceText.replace('"', '');
      replaceText = replaceText.replace('"', '');
      replaceText = replaceText.replace('/>', '');
      
      currentImage.src = replaceText;
		csdkImageEditor.launch({
			image: currentImage.id,
			url: currentImage.src
		});
    }
  });

  // Adds a menu item to the tools menu
  editor.addMenuItem('example', {
    text: 'Example plugin',
    context: 'tools',
    onclick: function() {
      // Open window with a specific url
      editor.windowManager.open({
        title: 'TinyMCE site',
        url: 'https://www.tinymce.com',
        width: 800,
        height: 600,
        buttons: [{
          text: 'Close',
          onclick: 'close'
        }]
      });
    }
  });

  return {
    getMetadata: function () {
      return  {
        name: "Example plugin",
        url: "http://exampleplugindocsurl.com"
      };
    }
  };
});
